"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils")),_conf=_interopRequireDefault(require("../../v-x-e-table/src/conf")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_utils=_interopRequireWildcard(require("../../tools/utils")),_util=require("./util"),_dom=_interopRequireDefault(require("../../tools/dom"));function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var l=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:l})(e)}function _interopRequireWildcard(e,l){if(!l&&e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};l=_getRequireWildcardCache(l);if(l&&l.has(e))return l.get(e);var t,r,o={},n=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&((r=n?Object.getOwnPropertyDescriptor(e,t):null)&&(r.get||r.set)?Object.defineProperty(o,t,r):o[t]=e[t]);return o.default=e,l&&l.set(e,o),o}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,l,t){return l in e?Object.defineProperty(e,l,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[l]=t,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,l){if(e){if("string"==typeof e)return _arrayLikeToArray(e,l);var t=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(t="Object"===t&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,l):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,l){(null==l||l>e.length)&&(l=e.length);for(var t=0,r=new Array(l);t<l;t++)r[t]=e[t];return r}var scrollProcessTimeout,renderType="body";function isOperateMouse(e){return e._isResize||e.lastScrollTime&&Date.now()<e.lastScrollTime+e.delayHover}function renderLine(e,l,t,r){var o=r.row,n=r.column,i=t.treeOpts,a=t.treeConfig,s=t.fullAllDataRowIdData,c=n.slots,d=n.treeNode,u=s[(0,_util.getRowid)(t,o)],n=0,s=0,o=[];return u&&(n=u.level,s=u._index,o=u.items),c&&c.line?t.callSlot(c.line,r,e):a&&d&&i.line?[e("div",{class:"vxe-tree--line-wrapper"},[e("div",{class:"vxe-tree--line",style:{height:"".concat((0,_util.calcTreeLine)(r,o,s),"px"),left:"".concat(n*i.indent+(n?2-(0,_util.getOffsetSize)(t):0)+16,"px")}})])]:[]}function renderColumn(e,l,t,r,o,n,i,a,s,c,d,u,p,f,y){var h,g=t.$listeners,v=t.afterFullData,m=t.tableData,w=t.height,b=t.columnKey,x=t.overflowX,_=t.sYOpts,T=t.scrollXLoad,S=t.scrollYLoad,O=t.highlightCurrentRow,C=t.showOverflow,L=t.isAllOverflow,$=t.align,R=t.currentColumn,k=t.cellClassName,I=t.cellStyle,H=t.mergeList,E=t.spanMethod,A=t.radioOpts,Y=t.checkboxOpts,P=t.expandOpts,W=t.treeOpts,D=t.tooltipOpts,M=t.mouseConfig,q=t.editConfig,B=t.editOpts,j=t.editRules,U=t.validOpts,X=t.editStore,N=t.validStore,z=t.tooltipConfig,F=t.rowOpts,K=t.columnOpts,V=u.type,G=u.cellRender,J=u.editRender,Q=u.align,Z=u.showOverflow,ee=u.className,le=u.treeNode,te=X.actived,re=_.rHeight,oe=F.height,ne=J||G,ie=ne?_vXETable.default.renderer.get(ne.name):null,ae=ie?ie.cellClassName:"",se=D.showAll||D.enabled,X=t.getColumnIndex(u),_=t.getVTColumnIndex(u),ne=(0,_utils.isEnableConf)(J),ie=n?u.fixed!==n:u.fixed&&x,D=_xeUtils.default.isUndefined(Z)||_xeUtils.default.isNull(Z)?C:Z,x="ellipsis"===D,ce="title"===D,de=!0===D||"tooltip"===D,Z=ce||de||x,D={},Q=Q||$,$=N.row===a&&N.column===u,j=j&&U.showMessage&&("default"===U.message?w||1<m.length:"inline"===U.message),w={colid:u.id},ue=g["cell-mouseenter"],pe=g["cell-mouseleave"],U=J&&q&&"dblclick"===B.trigger,fe={$table:t,seq:r,rowid:o,row:a,rowIndex:s,$rowIndex:c,_rowIndex:d,column:u,columnIndex:X,$columnIndex:p,_columnIndex:_,fixed:n,type:renderType,isHidden:ie,level:i,visibleData:v,data:m,items:y};if(!T&&!S||Z||(x=Z=!0),(ce||de||se||ue||z)&&(D.mouseenter=function(e){isOperateMouse(t)||(ce?_dom.default.updateCellTitle(e.currentTarget,u):(de||se)&&t.triggerBodyTooltipEvent(e,fe),ue&&t.emitEvent("cell-mouseenter",Object.assign({cell:e.currentTarget},fe),e))}),(de||se||pe||z)&&(D.mouseleave=function(e){isOperateMouse(t)||((de||se)&&t.handleTargetLeaveEvent(e),pe&&t.emitEvent("cell-mouseleave",Object.assign({cell:e.currentTarget},fe),e))}),(Y.range||M)&&(D.mousedown=function(e){t.triggerCellMousedownEvent(e,fe)}),(F.isCurrent||O||g["cell-click"]||J&&q||"row"===P.trigger||"cell"===P.trigger||"row"===A.trigger||"radio"===u.type&&"cell"===A.trigger||"row"===Y.trigger||"checkbox"===u.type&&"cell"===Y.trigger||"row"===W.trigger||u.treeNode&&"cell"===W.trigger)&&(D.click=function(e){t.triggerCellClickEvent(e,fe)}),(U||g["cell-dblclick"])&&(D.dblclick=function(e){t.triggerCellDblclickEvent(e,fe)}),H.length){d=(0,_util.mergeBodyMethod)(H,d,_);if(d){var _=d.rowspan,ye=d.colspan;if(!_||!ye)return null;1<_&&(w.rowspan=_),1<ye&&(w.colspan=ye)}}else if(E){ye=E(fe)||{},E=ye.rowspan,E=void 0===E?1:E,ye=ye.colspan,ye=void 0===ye?1:ye;if(!E||!ye)return null;1<E&&(w.rowspan=E),1<ye&&(w.colspan=ye)}!(ie=ie&&H&&(1<w.colspan||1<w.rowspan)?!1:ie)&&q&&(J||G)&&(B.showStatus||B.showUpdateStatus)&&(h=t.isUpdateByRow(a,u.field));G=[];return ie&&C&&L?G.push(e("div",{class:["vxe-cell",{"c--title":ce,"c--tooltip":de,"c--ellipsis":x}],style:{maxHeight:Z&&(re||oe)?"".concat(re||oe,"px"):""}})):(G.push.apply(G,_toConsumableArray(renderLine(e,l,t,fe)).concat([e("div",{class:["vxe-cell",{"c--title":ce,"c--tooltip":de,"c--ellipsis":x}],style:{maxHeight:Z&&(re||oe)?"".concat(re||oe,"px"):""},attrs:{title:ce?t.getCellLabel(a,u):null}},u.renderCell(e,fe))])),j&&$&&G.push(e("div",{class:"vxe-cell--valid",style:N.rule&&N.rule.maxWidth?{width:"".concat(N.rule.maxWidth,"px")}:null},[e("span",{class:"vxe-cell--valid-msg"},N.content)]))),e("td",{class:["vxe-body--column",u.id,(_defineProperty(e={},"col--".concat(Q),Q),_defineProperty(e,"col--".concat(V),V),_defineProperty(e,"col--last",p===f.length-1),_defineProperty(e,"col--tree-node",le),_defineProperty(e,"col--edit",ne),_defineProperty(e,"col--ellipsis",Z),_defineProperty(e,"fixed--hidden",ie),_defineProperty(e,"col--dirty",h),_defineProperty(e,"col--actived",q&&ne&&te.row===a&&(te.column===u||"row"===B.mode)),_defineProperty(e,"col--valid-error",$),_defineProperty(e,"col--current",R===u),e),_utils.default.getClass(ae,fe),_utils.default.getClass(ee,fe),_utils.default.getClass(k,fe)],key:b||K.useKey?u.id:p,attrs:w,style:Object.assign({height:Z&&(re||oe)?"".concat(re||oe,"px"):""},I?_xeUtils.default.isFunction(I)?I(fe):I:null),on:D},G)}function renderRows(y,h,g,v,m,w){var b=g.stripe,x=g.rowKey,_=g.highlightHoverRow,T=g.rowClassName,S=g.rowStyle,O=g.editConfig,C=g.showOverflow,L=g.treeConfig,$=g.treeOpts,R=g.editOpts,k=g.treeExpandeds,I=g.scrollYLoad,H=g.editStore,E=g.rowExpandeds,A=g.radioOpts,Y=g.checkboxOpts,P=g.expandColumn,W=g.hasFixedColumn,D=g.fullAllDataRowIdData,M=g.rowOpts,q=[];return m.forEach(function(t,r){var e={},o=g.getVTRowIndex(t),n=g.getRowIndex(t);(M.isHover||_)&&(e.mouseenter=function(e){isOperateMouse(g)||g.triggerHoverEvent(e,{row:t,rowIndex:n})},e.mouseleave=function(){isOperateMouse(g)||g.clearHoverRow()});var l,i=(0,_util.getRowid)(g,t),a=D[i],s=a?a.level:0,c=a?a.seq:-1,d={$table:g,seq:c,rowid:i,fixed:v,type:renderType,level:s,row:t,rowIndex:n,$rowIndex:r},u=P&&E.length&&-1<E.indexOf(t),p=!1,f=[],a=!1;O&&(a=-1<H.insertList.indexOf(t)),L&&!I&&!$.transform&&k.length&&(p=(f=t[$.children])&&f.length&&-1<k.indexOf(t)),q.push(y("tr",{class:["vxe-body--row",L?"row--level-".concat(s):"",{"row--stripe":b&&(g.getVTRowIndex(t)+1)%2==0,"is--new":a,"is--expand-row":u,"is--expand-tree":p,"row--new":a&&(R.showStatus||R.showInsertStatus),"row--radio":A.highlight&&g.selectRow===t,"row--checked":Y.highlight&&g.isCheckedByCheckboxRow(t)},T?_xeUtils.default.isFunction(T)?T(d):T:""],attrs:{rowid:i},style:S?_xeUtils.default.isFunction(S)?S(d):S:null,key:x||M.useKey||L?i:r,on:e},w.map(function(e,l){return renderColumn(y,h,g,c,i,v,s,t,n,r,o,e,l,w,m)}))),u&&(L&&(l={paddingLeft:"".concat(s*$.indent+30,"px")}),d=P.showOverflow,u=_xeUtils.default.isUndefined(d)||_xeUtils.default.isNull(d)?C:d,d={$table:g,seq:c,column:P,fixed:v,type:renderType,level:s,row:t,rowIndex:n,$rowIndex:r},q.push(y("tr",{class:"vxe-body--expanded-row",key:"expand_".concat(i),style:S?_xeUtils.default.isFunction(S)?S(d):S:null,on:e},[y("td",{class:["vxe-body--expanded-column",{"fixed--hidden":v&&!W,"col--ellipsis":u}],attrs:{colspan:w.length}},[y("div",{class:"vxe-body--expanded-cell",style:l},[P.renderData(y,d)])])]))),p&&q.push.apply(q,_toConsumableArray(renderRows(y,h,g,v,f,w)))}),q}function syncBodyScroll(e,l,t,r,o){(r||o)&&(r&&((0,_util.removeScrollListener)(r),r.scrollTop=t),o&&((0,_util.removeScrollListener)(o),o.scrollTop=t),clearTimeout(scrollProcessTimeout),scrollProcessTimeout=setTimeout(function(){(0,_util.restoreScrollListener)(r),(0,_util.restoreScrollListener)(o)},300))}var _default={name:"VxeTableBody",props:{tableData:Array,tableColumn:Array,fixedColumn:Array,size:String,fixedType:String},data:function(){return{wheelTime:null,wheelYSize:0,wheelYInterval:0,wheelYTotal:0}},mounted:function(){var e=this.$parent,l=this.$el,t=this.$refs,r=this.fixedType,e=e.elemStore,r="".concat(r||"main","-body-");e["".concat(r,"wrapper")]=l,e["".concat(r,"table")]=t.table,e["".concat(r,"colgroup")]=t.colgroup,e["".concat(r,"list")]=t.tbody,e["".concat(r,"xSpace")]=t.xSpace,e["".concat(r,"ySpace")]=t.ySpace,e["".concat(r,"emptyBlock")]=t.emptyBlock,this.$el.onscroll=this.scrollEvent,this.$el._onscroll=this.scrollEvent},beforeDestroy:function(){clearTimeout(this.wheelTime),this.$el._onscroll=null,this.$el.onscroll=null},destroyed:function(){var e=this.$parent,l=this.fixedType,e=e.elemStore,l="".concat(l||"main","-body-");e["".concat(l,"wrapper")]=null,e["".concat(l,"table")]=null,e["".concat(l,"colgroup")]=null,e["".concat(l,"list")]=null,e["".concat(l,"xSpace")]=null,e["".concat(l,"ySpace")]=null,e["".concat(l,"emptyBlock")]=null},render:function(t){var e=this._e,l=this.$parent,r=this.fixedColumn,o=this.fixedType,n=l.$scopedSlots,i=l.tId,a=l.tableData,s=l.tableColumn,c=l.visibleColumn,d=l.showOverflow,u=l.keyboardConfig,p=l.keyboardOpts,f=l.mergeList,y=l.spanMethod,h=l.scrollXLoad,g=l.scrollYLoad,v=l.isAllOverflow,m=l.emptyOpts,w=l.mouseConfig,b=l.mouseOpts,x=l.sYOpts;return o&&(s=!(h||g||d&&v)||f.length||y||u&&p.isMerge?c:r),m=n.empty?n.empty.call(this,{$table:l},t):(n=(n=m.name?_vXETable.default.renderer.get(m.name):null)?n.renderEmpty:null)?n.call(this,t,m,{$table:l}):l.emptyText||_conf.default.i18n("vxe.table.emptyText"),t("div",{class:["vxe-table--body-wrapper",o?"fixed-".concat(o,"--wrapper"):"body--wrapper"],attrs:{xid:i},on:g&&"wheel"===x.mode?{wheel:this.wheelEvent}:{}},[o?e():t("div",{class:"vxe-body--x-space",ref:"xSpace"}),t("div",{class:"vxe-body--y-space",ref:"ySpace"}),t("table",{class:"vxe-table--body",attrs:{xid:i,cellspacing:0,cellpadding:0,border:0},ref:"table"},[t("colgroup",{ref:"colgroup"},s.map(function(e,l){return t("col",{attrs:{name:e.id},key:l})})),t("tbody",{ref:"tbody"},renderRows(t,this,l,o,a,s))]),t("div",{class:"vxe-table--checkbox-range"}),w&&b.area?t("div",{class:"vxe-table--cell-area"},[t("span",{class:"vxe-table--cell-main-area"},b.extension?[t("span",{class:"vxe-table--cell-main-area-btn",on:{mousedown:function(e){l.triggerCellExtendMousedownEvent(e,{$table:l,fixed:o,type:renderType})}}})]:null),t("span",{class:"vxe-table--cell-copy-area"}),t("span",{class:"vxe-table--cell-extend-area"}),t("span",{class:"vxe-table--cell-multi-area"}),t("span",{class:"vxe-table--cell-active-area"})]):null,o?null:t("div",{class:"vxe-table--empty-block",ref:"emptyBlock"},[t("div",{class:"vxe-table--empty-content"},m)])])},methods:{scrollEvent:function(e){var l=this.$el,t=this.$parent,r=this.fixedType,o=t.$refs,n=t.elemStore,i=t.highlightHoverRow,a=t.scrollXLoad,s=t.scrollYLoad,c=t.lastScrollTop,d=t.lastScrollLeft,u=t.rowOpts,p=o.tableHeader,f=o.tableBody,y=o.leftBody,h=o.rightBody,g=o.tableFooter,v=o.validTip,m=p?p.$el:null,o=g?g.$el:null,p=f.$el,g=y?y.$el:null,f=h?h.$el:null,y=n["main-body-ySpace"],h=n["main-body-xSpace"],n=(s&&y?y:p).clientHeight,y=(a&&h?h:p).clientWidth,h=l.scrollTop,l=p.scrollLeft,d=l!==d,c=h!==c;t.lastScrollTop=h,t.lastScrollLeft=l,t.lastScrollTime=Date.now(),(u.isHover||i)&&t.clearHoverRow(),g&&"left"===r?syncBodyScroll(t,r,h=g.scrollTop,p,f):f&&"right"===r?syncBodyScroll(t,r,h=f.scrollTop,p,g):(d&&(m&&(m.scrollLeft=p.scrollLeft),o&&(o.scrollLeft=p.scrollLeft)),(g||f)&&(t.checkScrolling(),c&&syncBodyScroll(t,r,h,g,f))),a&&d&&t.triggerScrollXEvent(e),s&&c&&t.triggerScrollYEvent(e),d&&v&&v.visible&&v.updatePlacement(),t.emitEvent("scroll",{type:renderType,fixed:r,scrollTop:h,scrollLeft:l,scrollHeight:p.scrollHeight,scrollWidth:p.scrollWidth,bodyHeight:n,bodyWidth:y,isX:d,isY:c},e)},handleWheel:function(a,s,e,c,d){var u=this,p=this.$parent,l=p.$refs,t=p.elemStore,r=p.scrollYLoad,o=p.scrollXLoad,n=l.tableBody,i=l.leftBody,l=l.rightBody,f=n.$el,y=i?i.$el:null,h=l?l.$el:null,i=this.isPrevWheelTop===s?Math.max(0,this.wheelYSize-this.wheelYTotal):0,l=t["main-body-ySpace"],t=t["main-body-xSpace"],g=(r&&l?l:f).clientHeight,v=(o&&t?t:f).clientWidth;this.isPrevWheelTop=s,this.wheelYSize=Math.abs(s?e-i:e+i),this.wheelYInterval=0,this.wheelYTotal=0,clearTimeout(this.wheelTime),function e(){var l,t,r=u.fixedType,o=u.wheelYTotal,n=u.wheelYSize,i=u.wheelYInterval;o<n&&(n<(o+=i=Math.max(5,Math.floor(1.5*i)))&&(i-=o-n),t=f.scrollTop,l=f.clientHeight,n=f.scrollHeight,f.scrollTop=t=t+i*(s?-1:1),y&&(y.scrollTop=t),h&&(h.scrollTop=t),(s?t<n-l:0<=t)&&(u.wheelTime=setTimeout(e,10)),u.wheelYTotal=o,u.wheelYInterval=i,p.emitEvent("scroll",{type:renderType,fixed:r,scrollTop:f.scrollTop,scrollLeft:f.scrollLeft,scrollHeight:f.scrollHeight,scrollWidth:f.scrollWidth,bodyHeight:g,bodyWidth:v,isX:c,isY:d},a))}()},wheelEvent:function(e){var l=e.deltaY,t=e.deltaX,r=this.$el,o=this.$parent,n=o.$refs,i=o.highlightHoverRow,a=o.scrollYLoad,s=o.lastScrollTop,c=o.lastScrollLeft,d=o.rowOpts,u=n.tableBody.$el,n=l,l=n<0;(l?r.scrollTop<=0:r.scrollTop>=r.scrollHeight-r.clientHeight)||(r=r.scrollTop+n,c=(t=u.scrollLeft+t)!==c,(s=r!==s)&&(e.preventDefault(),o.lastScrollTop=r,o.lastScrollLeft=t,o.lastScrollTime=Date.now(),(d.isHover||i)&&o.clearHoverRow(),this.handleWheel(e,l,n,c,s),a&&o.triggerScrollYEvent(e)))}}};exports.default=_default;